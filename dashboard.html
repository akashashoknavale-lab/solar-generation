<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
.topbar{display:flex;justify-content:space-between;align-items:center}
button{padding:5px 10px;cursor:pointer}
table{border-collapse:collapse;width:100%;margin-top:10px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
</style>

<script>
/* üîê AUTH CHECK */
if(localStorage.getItem("loggedIn") !== "true"){
    window.location.href = "index.html";
}
</script>
</head>

<body>

<div class="topbar">
    <h2>Solar Plant Dashboard</h2>
    <div>
        <span id="userInfo"></span>
        <button onclick="logout()">Logout</button>
    </div>
</div>

<table id="summaryTable">
<thead>
<tr>
<th>Month</th>
<th>Total Generation</th>
<th>Avg PR</th>
<th>Avg Availability</th>
<th>Avg CUF</th>
</tr>
</thead>
<tbody></tbody>
</table>

<canvas id="genChart" height="100"></canvas>

<script>
const DATA_SHEET_URL = "PASTE_YOUR_GENERATION_SHEET_JSON_URL";

const role = localStorage.getItem("role");
const allowedPlants = localStorage.getItem("plants");
const username = localStorage.getItem("user");

userInfo.innerText = `${username} (${role})`;

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

fetch(DATA_SHEET_URL)
.then(r=>r.json())
.then(data=>{
    const monthData={};

    data.forEach(r=>{
        const plant = r.plant;
        if(role!=="admin" && allowedPlants!=="ALL" && !allowedPlants.split(",").includes(plant)) return;

        const m = r.month;
        if(!monthData[m]){
            monthData[m]={gen:0, pr:0, avail:0, cuf:0, cnt:0};
        }

        monthData[m].gen += +r.actual_generation || 0;
        monthData[m].pr  += +r.actual_pr || 0;
        monthData[m].avail += +r.availability || 0;
        monthData[m].cuf += +r.actual_cuf || 0;
        monthData[m].cnt++;
    });

    const labels=[], genArr=[];
    const tbody=document.querySelector("#summaryTable tbody");

    Object.keys(monthData).forEach(m=>{
        const d=monthData[m];
        labels.push(m);
        genArr.push(d.gen);

        tbody.innerHTML+=`
        <tr>
            <td>${m}</td>
            <td>${d.gen.toFixed(0)}</td>
            <td>${(d.pr/d.cnt).toFixed(2)}%</td>
            <td>${(d.avail/d.cnt).toFixed(2)}%</td>
            <td>${(d.cuf/d.cnt).toFixed(2)}%</td>
        </tr>`;
    });

    new Chart(genChart,{
        type:"bar",
        data:{
            labels,
            datasets:[{
                label:"Actual Generation",
                data:genArr
            }]
        }
    });
});
</script>

</body>
</html>
