<script>
const sheetURL =
"https://docs.google.com/spreadsheets/d/1ol61rCN9yLUSVHekPz9S5W7yEfWQTTas8-yJtxKf1ys/gviz/tq?tqx=out:csv&sheet=Tab";

let sheetData = [];
let chart;

/* -------- DATE HELPERS -------- */
function parseDate(str){
    const [d,m,y] = str.split("-").map(Number);
    return new Date(y, m-1, d);
}

function formatDate(date){
    return `${String(date.getDate()).padStart(2,"0")}-${String(date.getMonth()+1).padStart(2,"0")}-${date.getFullYear()}`;
}

/* -------- TODAY IN SEARCH -------- */
document.getElementById("searchDate").value = formatDate(new Date());

/* -------- FETCH DATA -------- */
fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.trim().split("\n");

    rows.slice(1).forEach(row => {
        const cols = row.split(",");

        const dateStr = cols[0]?.replace(/"/g,"").trim();
        if(!dateStr) return;

        const gen = parseFloat(cols[1]?.replace(/"/g,"").trim()) || 0;
        const avg = parseFloat(cols[2]?.replace(/"/g,"").trim()) || 0;

        sheetData.push({
            dateStr,
            dateObj: parseDate(dateStr),
            generation: gen,
            avg: avg
        });
    });

    populateTable();
    drawChart();
    updateLastMonthTotal();
});

/* -------- TABLE -------- */
function populateTable(){
    document.querySelector("#dataTable tbody").innerHTML =
        sheetData.map(d=>`
        <tr>
            <td>${d.dateStr}</td>
            <td>${d.generation}</td>
            <td>${d.avg}</td>
        </tr>`).join("");
}

/* -------- CHART -------- */
function drawChart(highlight=null){
    const last30 = sheetData.slice(-30);
    if(chart) chart.destroy();

    chart = new Chart(document.getElementById("generationChart"),{
        type:"bar",
        data:{
            labels:last30.map(d=>d.dateStr),
            datasets:[{
                data:last30.map(d=>d.generation),
                backgroundColor:last30.map(d=>
                    d.dateStr===highlight
                    ?"rgba(255,99,132,0.8)"
                    :"rgba(75,192,192,0.6)"
                )
            }]
        },
        options:{
            plugins:{
                legend:{display:false},
                datalabels:{
                    anchor:"end",
                    align:"end",
                    formatter:v=>v
                }
            },
            scales:{ y:{ beginAtZero:true } }
        },
        plugins:[ChartDataLabels]
    });
}

/* -------- LAST MONTH TOTAL -------- */
function updateLastMonthTotal(){
    const last = sheetData[sheetData.length-1].dateObj;
    let m = last.getMonth()-1;
    let y = last.getFullYear();
    if(m<0){ m=11; y--; }

    const total = sheetData
        .filter(d=>d.dateObj.getMonth()===m && d.dateObj.getFullYear()===y)
        .reduce((s,d)=>s+d.generation,0);

    document.getElementById("lastMonthTotal").textContent =
        `Last Month Total: ${total} kWh`;
}

/* -------- SEARCH -------- */
function searchData(){
    const val = document.getElementById("searchDate").value.trim();
    drawChart(val);
}
</script>
