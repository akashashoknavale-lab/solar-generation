<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pyramid Phase-1 Day Gen and Avg/KWp</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: #f4f4f4;
}
h1 { text-align: center; }

.search-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
}

input {
    padding: 10px;
    width: 260px;
}

button {
    padding: 10px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
}
button:hover { background: #45a049; }

#lastMonthTotal {
    font-weight: bold;
    font-size: 16px;
}

canvas {
    background: #fff;
    padding: 10px;
    margin-bottom: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}
th {
    background: #4CAF50;
    color: white;
}
</style>
</head>

<body>

<h1>Pyramid Phase-1 Day Generation</h1>

<div class="search-container">
    <input type="text" id="searchDate" placeholder="DD-MM-YYYY">
    <button onclick="searchData()">Search</button>
    <div id="lastMonthTotal">Last Month Total: 0 kWh</div>
</div>

<canvas id="generationChart" height="120"></canvas>

<table id="dataTable">
<thead>
<tr>
    <th>Date</th>
    <th>Generation</th>
    <th>Avg / kWp</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const sheetURL =
"https://docs.google.com/spreadsheets/d/1ol61rCN9yLUSVHekPz9S5W7yEfWQTTas8-yJtxKf1ys/gviz/tq?tqx=out:csv&sheet=Tab";

let sheetData = [];
let chart;

/* -------- FORMAT DATE TO DD-MM-YYYY -------- */
function formatDate(dateObj){
    const d = String(dateObj.getDate()).padStart(2,"0");
    const m = String(dateObj.getMonth()+1).padStart(2,"0");
    const y = dateObj.getFullYear();
    return `${d}-${m}-${y}`;
}

/* -------- PARSE DATE FROM SHEET -------- */
function parseDate(dateStr) {
    const sep = dateStr.includes("/") ? "/" : "-";
    const [d,m,y] = dateStr.split(sep).map(Number);
    return new Date(y, m-1, d);
}

/* -------- SET TODAY IN SEARCH BAR -------- */
document.getElementById("searchDate").value = formatDate(new Date());

/* -------- FETCH DATA -------- */
fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.trim().split("\n");
    rows.slice(1).forEach(row => {
        const cols = row.split(",");

        const rawDate = cols[0].replace(/"/g,"").trim();
        const dateObj = parseDate(rawDate);

        sheetData.push({
            dateStr: formatDate(dateObj),
            dateObj,
            generation: Number(cols[1]),
            avg: cols[2] ? Number(cols[2]) : ""
        });
    });

    populateTable();
    drawChart();
    updateLastMonthTotal();
});

/* -------- TABLE -------- */
function populateTable(){
    document.querySelector("#dataTable tbody").innerHTML =
        sheetData.map(d => `
        <tr>
            <td>${d.dateStr}</td>
            <td>${d.generation}</td>
            <td>${d.avg}</td>
        </tr>`).join("");
}

/* -------- CHART -------- */
function drawChart(highlight=null){
    const last30 = sheetData.slice(-30);
    if(chart) chart.destroy();

    chart = new Chart(document.getElementById("generationChart"),{
        type:"bar",
        data:{
            labels:last30.map(d=>d.dateStr),
            datasets:[{
                data:last30.map(d=>d.generation),
                backgroundColor:last30.map(d=>
                    d.dateStr===highlight
                    ?"rgba(255,99,132,0.8)"
                    :"rgba(75,192,192,0.6)"
                )
            }]
        },
        options:{
            plugins:{
                legend:{display:false},
                datalabels:{
                    anchor:"end",
                    align:"end",
                    font:{weight:"bold"}
                }
            },
            scales:{ y:{ beginAtZero:true } }
        },
        plugins:[ChartDataLabels]
    });
}

/* -------- LAST MONTH TOTAL -------- */
function updateLastMonthTotal(){
    const lastDate = sheetData[sheetData.length-1].dateObj;
    let month = lastDate.getMonth()-1;
    let year = lastDate.getFullYear();
    if(month<0){ month=11; year--; }

    const total = sheetData
        .filter(d=>d.dateObj.getMonth()===month && d.dateObj.getFullYear()===year)
        .reduce((s,d)=>s+d.generation,0);

    document.getElementById("lastMonthTotal")
        .textContent = `Last Month Total: ${total} kWh`;
}

/* -------- SEARCH -------- */
function searchData(){
    const date = document.getElementById("searchDate").value.trim();
    drawChart(date);
}
</script>

</body>
</html>
